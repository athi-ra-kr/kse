<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Children’s Day — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f7f8fc; --surface:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand1:#6366f1; --brand2:#a855f7; --danger:#ef4444;
      --shadow:0 10px 26px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 10% -10%, #eef2ff 0%, transparent 55%),
        radial-gradient(700px 420px at 110% 10%, #f5f3ff 0%, transparent 50%),
        var(--bg);
      display:flex; min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      width:240px;background:var(--surface);border-right:1px solid var(--border);
      display:flex;flex-direction:column;gap:12px;padding:20px;position:fixed;inset:0 auto 0 0;
      box-shadow:2px 0 8px rgba(0,0,0,.03);
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .brand .logo img{display:block}
    .nav h5{font-size:12px;color:#94a3b8;letter-spacing:.08em;text-transform:uppercase;margin:10px 0 6px}
    .nav a{
      display:flex;align-items:center;gap:10px;text-decoration:none;color:#374151;
      padding:10px 12px;border-radius:10px;transition:.2s;
    }
    .nav a:hover,.nav a.active{background:#eef2ff;color:#4f46e5}
    .logout{
      margin-top:auto;text-align:center;text-decoration:none;padding:10px 12px;border-radius:10px;
      background:#fff1f2;color:#b91c1c;border:1px solid #fecaca;transition:filter .2s;
    }
    .logout:hover{filter:brightness(1.02)}

    /* Main */
    .main{flex:1;margin-left:240px;padding:20px}
    @media (max-width:900px){ .sidebar{display:none} .main{margin-left:0} }

    .topbar{
      background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(15,23,42,.05);
      padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:12px;position:sticky;top:12px;z-index:10;
    }
    .search form{display:flex;gap:8px}
    input[type="search"]{
      width:280px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;border:none;cursor:pointer;text-decoration:none;
      padding:9px 12px;border-radius:10px;font-weight:700;font-size:14px;transition:filter .2s;
    }
    .btn.ghost{background:#fff;color:#111827;border:1px solid var(--border)}
    .btn:hover{filter:brightness(1.05)}
    @media (max-width:600px){
      .search form{flex-wrap:wrap}
      input[type="search"]{width:100%}
    }

    .container{max-width:1200px;margin:16px auto}
    .msg{padding:10px 12px;border-radius:12px;border:1px solid var(--border);margin-bottom:12px}
    .msg.success{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .msg.error{background:#fef2f2;color:#991b1b;border-color:#fecaca}

    /* Card & Table */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .card-header{
      display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);
    }

    .table-wrap{
      width:100%;
      overflow-x:auto;
      overflow-y:auto;
      max-height:75vh;
      border-radius:0 0 14px 14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      min-width:1180px;
    }
    th,td{
      padding:12px 10px;
      border-bottom:1px solid #eef2f7;
      text-align:left;
      vertical-align:middle;
      white-space:nowrap;
    }
    thead th{
      background:#f9fafb;
      color:#374151;
      position:sticky;
      top:0;
      z-index:5;
      border-bottom:2px solid #e5e7eb;
    }
    tbody tr:hover td{background:#f3f4f6}
    .muted{color:var(--muted)}
    .wrap{white-space:normal}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    /* Actions */
    .icon-btn{
      display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;
      border:1px solid var(--border);background:#fff;cursor:pointer;margin-right:6px;
      transition:transform .12s, background .12s;
    }
    .icon-btn:hover{background:#f8fafc;transform:translateY(-1px)}
    .icon{width:18px;height:18px;display:block}
    .icon.edit path,
    .icon.trash path{
      fill:none;
      stroke:#111827;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .icon-btn:hover .icon path{ stroke:#000; }

    .plus-btn{
      display:inline-flex;align-items:center;justify-content:center;
      width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#ffffff;
      color:#111827;font-size:20px;line-height:0;cursor:pointer;
      transition:transform .12s, background .12s;
    }
    .plus-btn:hover{background:#f8fafc;transform:translateY(-1px)}

    .table-wrap::-webkit-scrollbar{height:8px}
    .table-wrap::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.28);z-index:1000;padding:18px}
    .modal.open{display:block}
    .modal-card{
      margin:0 auto;max-width:900px;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);
      max-height:calc(100vh - 36px);display:flex;flex-direction:column;overflow:hidden;
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
    .x-btn{border:1px solid var(--border);width:38px;height:38px;border-radius:10px;background:#f8fafc;cursor:pointer}

    .modal-body{
      padding:14px 14px 6px 14px;
      overflow-y:auto;
      max-height:70vh;
    }

    .members-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 1100px){
      .members-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 560px){
      .members-grid{ grid-template-columns: 1fr; }
    }

    .member-card{
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      padding:10px;
    }
    .member-card .title{font-weight:700;margin-bottom:6px}
    .member-card .row{display:grid;grid-template-columns: 1fr;gap:10px}
    .member-card label{font-size:.9rem;color:#111827;display:block;margin-bottom:4px}
    .member-card input, .member-card select{
      width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:.98rem;background:#fff;
    }

    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .grid{grid-template-columns:1fr} }
    label{font-size:.9rem;color:#111827;display:block;margin-bottom:6px}
    select,input[type="text"],input[type="tel"],input[type="number"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:.98rem;background:#fff;
    }
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:#fff}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <a href="#" class="logo">
        <img src="https://www.kselimited.com/images/kselogo2.png" alt="KSE Logo" width="150" height="44">
      </a>
    </div>
    <nav class="nav">
      <a href="{% url 'eventapp:dashboard' %}"
         class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
         Applications
      </a>
      <a href="{% url 'eventapp:school_list' %}"
         class="{% if request.resolver_match.url_name == 'school_list' %}active{% endif %}">
         Schools
      </a>
      <a href="{% url 'eventapp:program_list' %}"
         class="{% if request.resolver_match.url_name == 'program_list' %}active{% endif %}">
         Programmes
      </a>
      <a href="{% url 'eventapp:winners' %}"
         class="{% if request.resolver_match.url_name == 'winners' %}active{% endif %}">
         Winners
      </a>
    </nav>

    <a class="logout" href="{% url 'eventapp:logout' %}">Logout</a>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="row">
        <strong style="font-size:1rem">🎉 Applications</strong>
        <span class="muted" style="margin-left:8px">Manage submissions</span>
      </div>
      <div class="row">
        <div class="search">
          <form method="get" action="">
            <input type="search" name="q" placeholder="Search reg no, name, mobile, school..." value="{{ q|default:'' }}">
            <button class="btn ghost" type="submit">Search</button>
            <a class="btn ghost" href="{% url 'eventapp:dashboard' %}">Reset</a>
          </form>
        </div>
      </div>
    </div>

    <div class="container">
      {% if messages %}
        {% for m in messages %}
          <div class="msg {{ m.tags }}">{{ m|safe }}</div>
        {% endfor %}
      {% endif %}

      <div class="card">
        <div class="card-header">
          <div class="muted">All Applications</div>
          <button class="plus-btn" title="Add Application" onclick="openAddModal()">+</button>
        </div>

        <!-- Export + Global refresh row -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 14px;gap:12px;flex-wrap:wrap">
          <a href="{% url 'eventapp:export_applications_csv' %}"
             class="btn btn-primary"
             style="padding:6px 12px;background:#2563eb;color:#fff;border-radius:6px;text-decoration:none;">
            ⬇️ Export CSV
          </a>

          <!-- ONE global refresh button -->
          <form method="post"
                action="{% url 'eventapp:applications_refresh_register_all' %}"
                onsubmit="return confirm('This will re-sequence ALL register numbers per LEVEL+PREFIX from 001 in submission order. Continue?')">
            {% csrf_token %}
            <button type="submit" class="btn"
                    style="padding:6px 12px;background:#10b981;color:#fff;border-radius:6px;">
              🔄 Refresh All Register Nos
            </button>
          </form>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Register No</th>
                <th>Program</th>
                <th class="wrap">School</th>
                <th class="wrap">Team Names</th>
                <th class="wrap">Team Mobiles</th>
                <th class="wrap">Alt Mobiles</th>
                <th class="wrap">Team Sections</th> <!-- NEW -->
                <th>Submitted</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
            {% for a in applications %}
              <tr>
                <td class="mono">{{ forloop.counter }}</td>
                <td class="mono"><strong>{{ a.register_no }}</strong></td>
                <td>{{ a.program_name }}</td>
                <td class="wrap">{{ a.school.name }}</td>

                <!-- Team Names -->
                <td class="wrap">
                  {% if a.members and a.members.0 %}
                    {{ a.members.0.name }}
                    {% if a.members|length > 1 %}
                      {% for m in a.members|slice:"1:" %}
                        <br>{{ m.name }}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    {{ a.name }}
                  {% endif %}
                </td>

                <!-- Team Mobiles -->
                <td class="wrap">
                  {% if a.members and a.members.0 %}
                    {{ a.members.0.mobile }}
                    {% if a.members|length > 1 %}
                      {% for m in a.members|slice:"1:" %}
                        <br>{{ m.mobile }}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    {{ a.mobile }}
                  {% endif %}
                </td>

                <!-- Alt Mobiles -->
                <td class="wrap">
                  {% if a.members and a.members.0 %}
                    {% if a.members.0.alt %}{{ a.members.0.alt }}{% else %}—{% endif %}
                    {% if a.members|length > 1 %}
                      {% for m in a.members|slice:"1:" %}
                        <br>{% if m.alt %}{{ m.alt }}{% else %}—{% endif %}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    — 
                  {% endif %}
                </td>

                <!-- NEW: Team Sections -->
                <td class="wrap">
                  {% if a.members and a.members.0 %}
                    {% if a.members.0.section %}{{ a.members.0.section }}{% else %}—{% endif %}
                    {% if a.members|length > 1 %}
                      {% for m in a.members|slice:"1:" %}
                        <br>{% if m.section %}{{ m.section }}{% else %}—{% endif %}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    — 
                  {% endif %}
                </td>

                <td class="mono">{{ a.submitted_at|date:"Y-m-d H:i" }}</td>
                <td>
                  <a class="icon-btn" href="{% url 'eventapp:application_edit' a.pk %}" title="Edit" aria-label="Edit">
                    <svg class="icon edit" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM17.71 7.21a1 1 0 0 0 0-1.42l-1.5-1.5a1 1 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.99-1.66z"/>
                    </svg>
                  </a>
                  <form method="post" action="{% url 'eventapp:application_delete' a.pk %}" style="display:inline" onsubmit="return confirm('Delete {{ a.register_no }}?')">
                    {% csrf_token %}
                    <button class="icon-btn" type="submit" title="Delete" aria-label="Delete">
                      <svg class="icon trash" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M6 7h12l-1 12H7L6 7zm3-3h6l1 1H8l1-1z"/>
                      </svg>
                    </button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="10" class="muted">No applications found{% if q %} for “{{ q }}”{% endif %}.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Quick Add Modal -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <div class="modal-head">
        <h3 id="addTitle">＋ Add Application</h3>
        <button class="x-btn" onclick="closeAddModal()" aria-label="Close">✕</button>
      </div>
      <form method="post" action="{% url 'eventapp:apply' %}" style="display:flex;flex-direction:column;height:100%;">
        {% csrf_token %}
        <div class="modal-body">
          <div class="grid">
            <div>
              <label for="qa_program">Program</label>
              <select id="qa_program" name="program_name" required>
                <option value="">Select program</option>
                <!-- Examples; free-text on server, but dropdown helps -->
                <option>KG Music</option><option>KG Dance</option><option>KG Drawing</option><option>KG Elocution</option><option>KG Folk Dance</option><option>KG Cinematic Dance</option><option>KG Fancy Dress</option><option>KG Group Song</option>
                <option>LP Music</option><option>LP Dance</option><option>LP Drawing</option><option>LP Elocution</option><option>LP Folk Dance</option><option>LP Cinematic Dance</option><option>LP Fancy Dress</option><option>LP Group Song</option>
                <option>UP Music</option><option>UP Dance</option><option>UP Drawing</option><option>UP Elocution</option><option>UP Folk Dance</option><option>UP Cinematic Dance</option><option>UP Fancy Dress</option><option>UP Group Song</option>
                <option>HS Music</option><option>HS Dance</option><option>HS Drawing</option><option>HS Elocution</option><option>HS Folk Dance</option><option>HS Cinematic Dance</option><option>HS Fancy Dress</option><option>HS Group Song</option>
              </select>
            </div>

            <div>
              <label for="qa_school">School</label>
              {% if schools %}
                <select id="qa_school" name="school_id" required>
                  <option value="">Select school</option>
                  {% for s in schools %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                  {% endfor %}
                </select>
              {% else %}
                <div class="muted" style="padding:10px;border:1px dashed #c7d2fe;border-radius:10px;background:#eef2ff">
                  No schools yet. Please add schools first.
                </div>
              {% endif %}
            </div>

            <div>
              <label for="qa_team">Team Size (2–8)</label>
              <input id="qa_team" type="number" name="team_size" min="2" max="8" value="2" required>
            </div>
          </div>

          <!-- Dynamic members render here -->
          <div id="qa_membersWrap" class="members-grid" style="margin-top:12px"></div>

          <!-- legacy mirror -->
          <input type="hidden" name="name" value="">
          <input type="hidden" name="mobile" value="">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn ghost" onclick="closeAddModal()">Cancel</button>
          <button class="btn ghost" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Modal open/close
    const addModal = document.getElementById('addModal');
    function openAddModal(){
      const form = addModal.querySelector('form');
      if (form) form.reset();

      // sync options and render
      syncSectionOptionsFromProgram();
      if (qaTeamInput){
        qaTeamInput.value = 2;
        renderMembers(2);
      }

      addModal.classList.add('open');
      addModal.setAttribute('aria-hidden','false');
    }
    function closeAddModal(){
      addModal.classList.remove('open');
      addModal.setAttribute('aria-hidden','true');
    }
    addModal.addEventListener('click', (e)=>{ if(e.target === addModal) closeAddModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && addModal.classList.contains('open')) closeAddModal(); });

    // ===== Dynamic members (2..8) + SECTION per member =====
    const qaTeamInput = document.getElementById('qa_team');
    const qaMembersWrap = document.getElementById('qa_membersWrap');
    const qaProgram = document.getElementById('qa_program');

    function clampTeam(n){ return Math.max(2, Math.min(8, n)); }
    const TEN_DIGITS = "^\\d{10}$";

    const SECTION_MAP = {
      'KG' : ['Pre-KG','LKG','UKG'],
      'LP' : ['1','2','3','4'],
      'UP' : ['5','6','7'],
      'HS' : ['8','9','10']
    };
    let currentSectionOptions = [];

    function getCategoryFromProgramLabel(label){
      if(!label) return '';
      const first = label.trim().split(/\s+/)[0].toUpperCase();
      return (['KG','LP','UP','HS'].includes(first)) ? first : '';
    }
    function syncSectionOptionsFromProgram(){
      const label = qaProgram?.value || '';
      const cat = getCategoryFromProgramLabel(label);
      currentSectionOptions = SECTION_MAP[cat] || [];
    }
    function optionsHTML(opts){
      return opts.map(o=>`<option value="${o}">${o}</option>`).join('');
    }

    function memberCard(i){
      const idx = i - 1;
      return `
        <div class="member-card">
          <div class="title">Member ${i}</div>
          <div class="row">
            <div>
              <label for="members-${idx}-name">Name</label>
              <input id="members-${idx}-name" type="text" name="members-${idx}-name" placeholder="Full name" required>
            </div>

            <div>
              <label for="members-${idx}-section">Class / Section</label>
              <select id="members-${idx}-section" name="members-${idx}-section" required>
                ${optionsHTML(currentSectionOptions)}
              </select>
            </div>

            <div>
              <label for="members-${idx}-mobile">Mobile</label>
              <input id="members-${idx}-mobile" type="tel" name="members-${idx}-mobile" placeholder="10 digits" pattern="${TEN_DIGITS}" maxlength="10" minlength="10" required>
            </div>
            <div>
              <label for="members-${idx}-alt">Alt phone (optional)</label>
              <input id="members-${idx}-alt" type="tel" name="members-${idx}-alt" placeholder="10 digits (optional)" pattern="${TEN_DIGITS}" maxlength="10" minlength="10">
            </div>
          </div>
        </div>
      `;
    }

    function renderMembers(n){
      n = clampTeam(n);
      let html = '';
      for(let i=1; i<=n; i++){ html += memberCard(i); }
      qaMembersWrap.innerHTML = html;

      // default select first option where applicable
      if(currentSectionOptions.length){
        qaMembersWrap.querySelectorAll('select[id$="-section"]').forEach(sel=>{
          if(!sel.value){ sel.value = currentSectionOptions[0]; }
        });
      }
    }

    if(qaTeamInput && qaMembersWrap){
      syncSectionOptionsFromProgram();
      renderMembers(parseInt(qaTeamInput.value || '2', 10));
      qaTeamInput.addEventListener('input', () => {
        let n = parseInt(qaTeamInput.value || '2', 10);
        if (isNaN(n)) n = 2;
        renderMembers(n);
      });
    }

    if(qaProgram){
      qaProgram.addEventListener('change', () => {
        syncSectionOptionsFromProgram();
        const n = parseInt(qaTeamInput.value || '2', 10) || 2;
        renderMembers(n);
      });
    }

    // Mirror Member 1 into legacy fields on submit
    const addForm = document.querySelector('#addModal form');
    if(addForm && !addForm._wireMembers){
      addForm.addEventListener('submit', function(){
        const m1Name = addForm.querySelector('input[name="members-0-name"]')?.value?.trim() || '';
        const m1Mobile = addForm.querySelector('input[name="members-0-mobile"]')?.value?.trim() || '';
        addForm.querySelector('input[name="name"]').value = m1Name;
        addForm.querySelector('input[name="mobile"]').value = m1Mobile;
      });
      addForm._wireMembers = true;
    }
  </script>
</body>
</html>
